{% extends 'tours/base.html' %}
{% load static %}
{% load i18n %}

{% block content %}

<section class="transfer-banner text-center text-white d-flex align-items-center" 
         style="background: url('/static/images/transfer-banner.jpg') center/cover no-repeat; height: 350px;">
  <div class="container">
    <h1 class="fw-bold display-4">{% trans "Book Your Transfer" %}</h1>
    <p class="lead fs-4">{% blocktrans %}Comfortable rides between Egyptâ€™s top destinations.<br>Fast, safe, and hassle-free.{% endblocktrans %}</p>
  </div>
</section>

<section class="transfer-form-section py-5">
  <div class="container">
    <div class="row">
      
      <div class="col-lg-8">
  <form id="transferForm" class="transfer-form" method="POST" action="{% url 'transfers_booking' %}">
    {% csrf_token %}

    <h2 class="mb-4">{% trans "Reserve Your Ride" %}</h2>

    <div class="form-group mb-3">
      <label for="full_name">{% trans "Full Name" %}</label>
      <input type="text" id="full_name" name="full_name" class="form-control" required>
    </div>

    <div class="form-group mb-3">
      <label for="email">{% trans "Email" %}</label>
      <input type="email" id="email" name="email" class="form-control" required>
    </div>

    <div class="form-group mb-3">
      <label for="phone">{% trans "Phone Number" %}</label>
      <input type="text" id="phone" name="phone" class="form-control" required>
    </div>

    <div class="form-group mb-3">
      <label for="pickupInput">{% trans "Pickup Location" %}</label>
      <div class="input-group">
        <input type="text" id="pickupInput" name="pickup" placeholder="{% trans 'Enter pickup location' %}" class="form-control" required>
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#mapModal" onclick="setActiveField('pickup')">
          {% trans "Open Map" %}
        </button>
      </div>
    </div>

    <div class="form-group mb-3">
      <label for="dropoffInput">{% trans "Drop-off Location" %}</label>
      <div class="input-group">
        <input type="text" id="dropoffInput" name="dropoff" placeholder="{% trans 'Enter drop-off location' %}" class="form-control" required>
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#mapModal" onclick="setActiveField('dropoff')">
          {% trans "Open Map" %}
        </button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="date">{% trans "Date" %}</label>
        <input type="date" id="date" name="date" class="form-control" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="time">{% trans "Time" %}</label>
        <input type="time" id="time" name="time" class="form-control" required>
      </div>
    </div>

    <div class="form-group mb-3">
      <label for="passengers">{% trans "Number of Passengers" %}</label>
      <input type="number" id="passengers" name="passengers" min="1" value="1" class="form-control" required>
    </div>

    <div class="form-group mb-3">
      <label for="car_type">{% trans "Car Type" %}</label>
      <select id="car_type" name="car_type" class="form-control" required>
        <option value="" disabled selected>{% trans "Select car type" %}</option>
        <option value="sedan" data-rate="50">{% trans "Sedan (2-3 pax) â€“ 50 EGP/km" %}</option>
        <option value="van" data-rate="70">{% trans "Van (5-7 pax) â€“ 70 EGP/km" %}</option>
        <option value="minibus" data-rate="90">{% trans "MiniBus (10-15 pax) â€“ 90 EGP/km" %}</option>
        <option value="vip" data-rate="150">{% trans "VIP (Mercedes / BMW) â€“ 150 EGP/km" %}</option>
      </select>
    </div>

    <input type="hidden" name="distance" id="hidden_distance" required>
    <input type="hidden" name="price" id="hidden_price" required>
    <input type="hidden" name="pickup_lat" id="pickup_lat" required>
    <input type="hidden" name="pickup_lon" id="pickup_lon" required>
    <input type="hidden" name="dropoff_lat" id="dropoff_lat" required>
    <input type="hidden" name="dropoff_lon" id="dropoff_lon" required>

    <div class="price-box p-3 border rounded mb-3">
      <p>{% trans "Estimated Price:" %} <span id="price">â€”</span> EGP</p>
      <p>{% trans "Distance:" %} <span id="distance">â€”</span> km</p>
    </div>

    <div class="form-group mb-3 d-flex justify-content-center">
        {{ form.captcha }}
    </div>
    <button type="button" id="submitBtn" class="btn btn-warning w-100">{% trans "Book Now" %}</button>
  </form>
</div>

<div id="successMessage" class="alert alert-success text-center fs-4" style="display:none;" 
     data-trans-error="{% trans 'Something went wrong. Please try again.' %}"
     data-trans-sending-error="{% trans 'Error sending booking request.' %}"
>
  ğŸ‰ {% trans "Your booking has been confirmed! We will contact you shortly." %}
</div>

      <div class="col-lg-4">
        <div class="bg-white p-4 rounded shadow-sm">
          <h3 class="fw-bold text-dark mb-4">{% trans "Available Cities" %}</h3>
          <ul class="list-unstyled fs-5">
            <li class="fw-bold text-success">âœ… {% trans "Hurghada" %}</li>
            <li class="text-muted">ğŸš§ {% trans "Cairo" %} ({% trans "Coming Soon" %})</li>
            <li class="text-muted">ğŸš§ {% trans "Sharm El-Sheikh" %} ({% trans "Coming Soon" %})</li>
            <li class="text-muted">ğŸš§ {% trans "Luxor" %} ({% trans "Coming Soon" %})</li>
            <li class="text-muted">ğŸš§ {% trans "El Gouna" %} ({% trans "Coming Soon" %})</li>
            <li class="text-muted">ğŸš§ {% trans "Marsa Alam" %} ({% trans "Coming Soon" %})</li>
          </ul>
          <p class="small text-muted mt-3">{% trans "More destinations will be available soon across Egypt." %}</p>
        </div>
      </div>

    </div>
  </div>
</section>

<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Select Location" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="mapSearchInput" placeholder="{% trans 'Search on map...' %}" class="form-control mb-2">
        <ul id="searchResults" class="list-group mb-3"></ul>
        <div id="map" style="height: 500px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">{% trans "Done" %}</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
let activeField = null;
let map, pickupMarker, dropoffMarker, control;

// Translation strings from Django
const translations = {
    selectedOnMap: "{% trans 'Selected on map' %}"
};

const pickupIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [30, 40],
  iconAnchor: [15, 40]
});

const dropoffIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [30, 40],
  iconAnchor: [15, 40],
  className: "dropoff-icon"
});

function setActiveField(field) {
  activeField = field;
  setTimeout(() => map.invalidateSize(), 500);
}

document.addEventListener("DOMContentLoaded", function() {
  map = L.map('map').setView([27.2579, 33.8116], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  map.on("click", function(e) {
    setMarker(e.latlng.lat, e.latlng.lng, translations.selectedOnMap);
  });
});

function setMarker(lat, lon, label) {
  if (activeField === "pickup") {
    if (pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat, lon], {icon: pickupIcon}).addTo(map).bindPopup(label).openPopup();
    document.getElementById("pickupInput").value = label;
    document.getElementById("pickup_lat").value = lat;
    document.getElementById("pickup_lon").value = lon;
  } else if (activeField === "dropoff") {
    if (dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat, lon], {icon: dropoffIcon}).addTo(map).bindPopup(label).openPopup();
    document.getElementById("dropoffInput").value = label;
    document.getElementById("dropoff_lat").value = lat;
    document.getElementById("dropoff_lon").value = lon;
  }
  calculateRoute();
}

document.getElementById("mapSearchInput").addEventListener("input", function(e) {
  let query = e.target.value;
  if (query.length < 3) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
    .then(res => res.json())
    .then(data => {
      let resultsList = document.getElementById("searchResults");
      resultsList.innerHTML = "";
      data.forEach(place => {
        let li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.textContent = place.display_name;
        li.onclick = () => {
          map.setView([place.lat, place.lon], 14);
          setMarker(place.lat, place.lon, place.display_name);
          resultsList.innerHTML = "";
        };
        resultsList.appendChild(li);
      });
    });
});

function calculateRoute() {
  if (pickupMarker && dropoffMarker) {
    if (control) map.removeControl(control);

    control = L.Routing.control({
      waypoints: [
        pickupMarker.getLatLng(),
        dropoffMarker.getLatLng()
      ],
      routeWhileDragging: false,
      addWaypoints: false,
      draggableWaypoints: false
    }).addTo(map);

    control.on('routesfound', function(e) {
      var distance = e.routes[0].summary.totalDistance / 1000;
      document.getElementById("distance").textContent = distance.toFixed(2);
      document.getElementById("hidden_distance").value = distance.toFixed(2);

      var carType = document.getElementById("car_type");
      var rate = parseFloat(carType.options[carType.selectedIndex].dataset.rate);
      var price = distance * rate;
      document.getElementById("price").textContent = price.toFixed(2);
      document.getElementById("hidden_price").value = price.toFixed(2);
    });
  }
}

// âœ… Ø²Ø±Ø§Ø± Book Now
document.getElementById("submitBtn").addEventListener("click", function() {
  let form = document.getElementById("transferForm");
  const successMessageDiv = document.getElementById("successMessage");

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  let formData = new FormData(form);

  fetch(form.action, {
    method: "POST",
    body: formData,
    headers: {
      "X-Requested-With": "XMLHttpRequest"
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      form.style.display = "none";
      successMessageDiv.style.display = "block";
    } else {
      alert("âŒ " + (successMessageDiv.dataset.transError || "Something went wrong. Please try again."));
    }
  })
  .catch(err => {
    console.error(err);
    alert("âŒ " + (successMessageDiv.dataset.transSendingError || "Error sending booking request."));
  });
});

// âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ù„Ù…Ø§ ÙŠØªØºÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
document.getElementById("car_type").addEventListener("change", calculateRoute);
</script>

{% endblock %}